name: Brew Formula Bump

on:
  push:
    tags:
      - "v*"

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Compute version and URL
        id: vars
        run: |
          TAG="${GITHUB_REF_NAME}"
          VER="${TAG#v}"
          URL="https://github.com/${GITHUB_REPOSITORY}/archive/refs/tags/${TAG}.tar.gz"
          echo "version=$VER" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
      - name: Download source tarball
        run: |
          curl -L "${{ steps.vars.outputs.url }}" -o src.tar.gz
      - name: Compute sha256
        id: sha
        run: |
          SHA=$(shasum -a 256 src.tar.gz | awk '{print $1}')
          echo "sha256=$SHA" >> $GITHUB_OUTPUT
      - name: Update formula
        run: |
          FILE=formula/ggufy.rb
          sed -i.bak "s|^  url \".*\"|  url \"${{ steps.vars.outputs.url }}\"|" "$FILE"
          sed -i.bak "s|^  sha256 \".*\"|  sha256 \"${{ steps.sha.outputs.sha256 }}\"|" "$FILE"
          sed -i.bak "s|^  version \".*\"|  version \"${{ steps.vars.outputs.version }}\"|" "$FILE"
          rm -f "$FILE.bak"
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add formula/ggufy.rb
          git commit -m "Bump Homebrew formula to ${{ steps.vars.outputs.version }}"
          git push