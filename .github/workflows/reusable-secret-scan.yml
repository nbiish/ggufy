name: Reusable Secret Scan

on:
  workflow_call:
    inputs:
      scan-depth:
        description: 'Depth of commit history to scan'
        required: false
        type: string
        default: '0'
      fail-on-error:
        description: 'Whether to fail the workflow if secrets are found'
        required: false
        type: boolean
        default: true

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: ${{ inputs.scan-depth }}

      - name: Determine diff range for TruffleHog
        id: diff-range
        shell: bash
        run: |
          set -euo pipefail
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          ZERO_SHA="0000000000000000000000000000000000000000"

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch origin "${{ github.event.pull_request.base.ref }}" --depth=$(( ${{ inputs.scan-depth }} + 1 ))
            echo "base=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
            echo "head=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          elif [[ -n "${{ github.event.before }}" && "${{ github.event.before }}" != "$ZERO_SHA" ]]; then
            echo "base=${{ github.event.before }}" >> "$GITHUB_OUTPUT"
            echo "head=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          else
            git fetch origin "$DEFAULT_BRANCH" --depth=2
            echo "base=$(git rev-parse origin/$DEFAULT_BRANCH)" >> "$GITHUB_OUTPUT"
            echo "head=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi

          echo "Resolved diff range: $(cat "$GITHUB_OUTPUT")"

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ steps.diff-range.outputs.base }}
          head: ${{ steps.diff-range.outputs.head }}
          extra_args: --debug --only-verified

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
