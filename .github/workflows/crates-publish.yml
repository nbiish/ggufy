name: Publish Crate

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify version matches tag
        run: |
          TAG="${GITHUB_REF_NAME}"
          VER_TAG="${TAG#v}"
          VER_FILE=$(grep -E '^version\s*=\s*"[^"]+"' Cargo.toml | head -1 | sed -E 's/.*"([^"]+)".*/\1/')
          echo "tag=$VER_TAG file=$VER_FILE"
          test "$VER_TAG" = "$VER_FILE"
      - uses: dtolnay/rust-toolchain@stable
      - name: Publish
        if: ${{ secrets.CRATES_IO_TOKEN != '' }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish --locked